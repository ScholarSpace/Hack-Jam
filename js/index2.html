<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="application/javascript" src="/polyfills/browser-polyfill.js"></script>
    <title>SP-Database</title>
    <link rel="icon" type="image/x-icon" href="/image/favicon.ico">
</head>
<body>
    <h1>ScholarSpace Database</h1>
    <script>
        //check if indexed db is supported on browser
        if(self.indexedDB){
    console.log("IndexedDB is supported");
}
    //check if database exists:
    //var request = self.indexedDB.open('SCHOLAR_DB',1);
    const sp_db = (function init() {
    let db = null;
    let open_dbReq = indexedDB.open("SCHOLAR_DB", 1);

     //onupgradeneeded
     open_dbReq.onupgradeneeded = function(event) { 
        console.log("upgrade");
        // notfiy of database version update:
        let oldVersion = ev.oldVersion;
        let newVersion = db.version;
        console.log("Database upgraded from:",oldVersion," to", newVersion);
        //create store:
        if( !db.objectStoreNames.contains("studentDetails")&&
            !db.objectStoreNames.contains("jobDetails")&&
            !db.objectStoreNames.contains("recruiters")&&
            !db.objectStoreNames.contains("chatMessage")&& 
            !db.objectStoreNames.contains("security"))
        {
            // student information store:
            var studentDetails = db.createObjectStore("studentDetails", {keypath: 'studentId'});
            studentDetails.createIndex("studentId_unique","studentId",{unique: true});//create unique index:
            //jobs store:
            var jobDetails = db.createObjectStore("jobDetails", {keypath: 'jobId'});
            jobDetails.createIndex("jobId_unique","jobId",{unique: true});
            //recruiters store:
            var recruiters = db.createObjectStore("recruiters", {keypath: 'recId'});
            recruiters.createIndex("recId_unique","recId",{unique: true});
            //chat interface store:
            var chatMessage = db.createObjectStore("chatMessage", {keypath: 'messageId'});
           chatMessage.createIndex("messageId_unique","messageId",{unique: true});
            //security store:
            var security = db.createObjectStore("security", {keypath: 'securityId'});
            security.createIndex("securityId_unique","securityId",{unique: true});
        }   
    }   
  
     //success:
     open_dbReq.onsuccess = function(event) {
        console.log("successs",db);
       
        //studentStore:
        var studentDetails  = [
        {   id, 
            name, 
            surname, 
            age, 
            emailAddress, 
            password,
            insitution, 
            qualification,
            yos, 
            startDate, 
            endDate}
    ];
 //jobStore:
    var jobDetails  = [
        {   jobId,
            jobTitle,
            jobType,
            location,
            payRate,
            duration,
            active,
            shortlist,
            hiredStaff}
    ];
    //recruitersStore:
    var recruiters  = [
        {  recId,
            verfied,
            name,
            surname,
            password,
            recruiterType,
            companyName,
            emailAddress,
            socialLinks}
    ];
    //chatStore:
    var chatMessage  = [
        {  studentId,recId,
            messageId,isRead,
            messageUser,
            messageStudent,
            timeStamp}
    ];
    //securityStore:
    var security  = [
        {  studentId,
            recId,
            securityLog,
            password
            }
    ];
         // get database from event
         var db_ = event.target.result;
         //create a transaction from the database:
        var transaction = db_.transaction(['studentDetails','jobDetails',
                                            'recruiters','chatMessage',
                                            'security'],'readwrite');
       
        //add event handling for success, error and abort:
        transaction.onsuccess = function(event){
            console.log("[Transaction] COMPLETED!");
        }
        transaction.onerror = function(event){
            console.log("ERROR OCCURED ON [Transaction]");
        }
        transaction.onabort = function(event){
            console.log("[Transaction] ABORTED!");
        }
        //get store from transaction:
        var studentStore = transaction.objectStore("studentDetails");
        var jobDetailsStore = transaction.objectStore("jobDetails");
        var recruitersStore = transaction.objectStore("recruiter");
        var chatMessageStore = transaction.objectStore("chatMessage");
        var securityStore = transaction.objectStore("security");
    }   
    
    //error event:
    open_dbReq.onerror = function(event) {
        console.log('[onerror]', open_dbReq.error);
    }    

});


/*
SOME CODE:

// put details into the students store 
studentDetails.forEach(function(stdDetails){
    var add_request = studentDetailsStore.add(studentDetails);

    add_request.onsuccess = function(event) {
        console.log(event.target.result == studentDetails.studentId); // true
    }
});

// count number of objects in store
studentStore.count().onsuccess = function(event) {
    console.log('[Transaction - COUNT] number of students in store', event.target.result);
};

// get studentDetails with id:
studentStore.get('ST01').onsuccess = function(event) {
    console.log('[Transaction - GET] student with id ST01', event.target.result);
};

 // update studentDetails with id 1
studentDetails[0].name = 'Musa';
StudentStore.put(products[0]).onsuccess = function(event) {
    console.log('[Transaction - PUT] student with id ST01', event.target.result);
};

// delete student with id 2
studentStore.delete(2).onsuccess = function(event) {
    console.log('[Transaction - DELETE] deleted with id 2');
};

*/
    </script>
    
</body>
</html>

